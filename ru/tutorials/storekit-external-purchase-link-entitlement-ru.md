Apple разрешила направлять пользователей из РФ на оплату цифровых покупок в приложении на **внешнем** сайте, минуя AppStore payments. Но чтобы вы могли это делать, нужно подать заявку, получить разрешение и обновить приложения.

> Внутри одного региона вы **не можете** одновременно принимать и внешние платежи, и классические платежи через App Store. Нужно выбрать что-то одно.

В статье рассматриваем только External Purchase Link. Но есть еще и External Purchas (без Link), где внешняя покупка осуществляется в интерфейсе приложения. Например, данные карты предлагается ввести на одном из экранов.

# Заявка

Заявка это что-то вроде анкеты, практически все поля заполянется автоматически. Подавать заявку [по этой ссылке](https://developer.apple.com/contact/request/storekit-external-entitlement-ru).

> Ссылка на заявку работает только регионов, где разрешили внешние покупки.

![Указываете ваш эквайринг](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/request-welcome.jpg?v=1)

Обязательно примите соглашение о платных приложениях, иначе форма заявки не откроется.

Дальше в заявке введите название приложения (локализация не важна), Bundle ID и описание. Здесь мы написали коротко: приложение доступно только для iOS, внутри есть бесплатный и платный доступ.

![Заполняете инфо о приложении](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/request-app-info.jpg?v=1)

Следующий шаг — указать ваш эквайринг:

![Указываете ваш эквайринг](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/reqeust-payment-processing.jpg?v=1)

> Проверяйте чтобы эквайринг был не под санкциями. Нашу заявку отклонили, потому что мы указали ЮКассу.

Теперь заполянем информация о веб-сайте, здесь нужно указать страницу оплаты (куда будете направлять пользователей) и страницу поддержки по вопросам платежей.

> Ссылка может содержать только путь. В ней не должно быть параметров и меток. URL в заявке должен совпадать с реальными ссылками. Эти URL вы будете добавлять в `Info.plist`.

![Заполняете инфо о сайте](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/request-website-info.jpg?v=1)

## Требования к сайту

На сайте нужно указать:

- Оплачивать безопасно: используется шифрование платежных систем VISA INTERNATIONAL, MasterCard Worldwide, МИР 
- Контакты технической поддержки по обработке платежей
- Приложение @yourapp поддерживает оплату по внешней ссылке
- Ваша компания несёт ответственность за возврат платежей

Как пример, зайдите на [нашу страницу](https://rentel.app/rentel-support?v=1).

Последний шаг — заполнить информацию о компании, заполянется руководителем:

![Заполняете инфо о компании](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/request-company-info.jpg)

# Проверка заявки

Нашу заявку отклонили через 7 дней, потому что эквайринг ЮКасса под санкциями. Мы сменили эквайринг на Райффайзен, заполнили новую заявку. Но не смогли ее отправить — наша старая заявка висела в статусе расмотрения.

Месяц мы писали на eurodev@apple.com, чтобы анулировать первую заявку. Она блокировала подачу новой заявки. Это была не наша вина, мы потеряли месяц.

Я отправил вторую заявку, и через 7 дней увидел в Apple Developer что мне доступен `Additional Capabilities` для бандла приложения.

![Новый Capability](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/additional-capabilities.jpg?v=1)

Уведомлений на почту не приходило, так что регулярно проверяйте Developer, Certifies,Identifiers & Profiles.

Внутри `Additional Capabilities` выбираете `ExternalPurchaseLink` и применяете изменения. Теперь нужно интегрировать эту capabilty в приложение.  

# Настраиваем приложение

В списке Capability появится новая `StoreKit External Purchase Link Entitlement (RU)`. Добавляете к приложению:

![Добавляете Capability](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/capability.jpg?v=1)

В `Info.plist` добавляем словарь. В словаре указываем ссылку на оплату на сайте, для каждой страны своя ссылка:

```
<key>SKExternalPurchaseLink</key>
<dict>
   <key>ru</key>
   <string>https://yourapp.com/price</string>
</dict>
```

Аббревиатура страны по стандарту ISO.

Сайт внешних покупок нужно открывать не как ссылку, а вызывать `try await ExternalPurchaseLink.open()` из StoreKit. Пользователю покажут системный диклеймер, что “полномочия Apple всё”, и если что-то пойдёт не так, разбираться с разработчиком придётся самостоятельно.

![Системный диклеймер перед редиректом](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/system-dicamer-before-payment.png?v=1)

# Проверка приложения

Когда отправляете на проверку, прикрепите видео, где видно процесс авторизации, окно со встроенными покупками и переход на сайт. Обязательно показать что URL совпадает с URL в заявке.

> В гайдах говорят про скриншот, но нас попросили именно видео.

Видео можно залить на хостинг, и в коментарий указать ссылку. Коментарий для ревьюера не пропадает между версиями, так что сделать это придется один раз.

Мы отправили билд на проверку, но получили реджект. Правила для UI к этому моменту обновили, возможно, в будущем будут ещё обновления. Выяснилось, что нельзя показывать тарифы в самом приложении, только кнопку на сайт для платежа. 

Оформили в точности как в примере для американского референса для аналогичной capability, даже иконку в кнопке. Символа иконки нет в SFSymbols, поэтому ниже в статье есть ссылка на картинку в векторе.

![В приложении нельзя указывать тарифы](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/reject.jpg?v=1)

Мы обновили приложение и прошли в App Store:

[Rentel в App Store](https://apps.apple.com/app/id1632637156): Здесь описание приложения

На странице приложения в App Store появилась вот такая метка. Мне бы больше понравился жёлтый восклицательный знак, но что поделать.

![Превью приложения в App Store](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/appstore-app-preview.jpg?v=1)

# Комиссия и отчёты

Компания должна регулярно отправлять 2 отчета: сводный и подробный. 

**Сводный** информирует об общем кол-ве продаж подписок и общей полученной девелопером сумме с продаж, за вычетом региональных налогов. 

**В подробном** требуется отчитаться о каждой оплаченной подписке с указанием SKU транзакции из чека на оплату.

Для отправки отчетов предоставляется 15 дней. Мы уже отправили в Apple Distribution International отчеты за финансовый период 31.12.23 - 03.02.24. Если бы мы не отправили их, то сотрудники Apple связались бы с нами 18.02.24, о чем написали бы нам на почту.

Каждый месяц мы отправляем отчеты по форме Apple о покупках. На основе отчетов в личном кабинете появляются счета за комиссию, 27%.

# Ссылки по теме

[Официальная Инструкция для RU](https://developer.apple.com/contact/request/storekit-external-entitlement-ru): Официальная инструкция и запрос StoreKit Entitlement. Ссылка открывается только если аккаунт владельца с регионом РФ
[Инструкиця для US](https://developer.apple.com/support/storekit-external-entitlement-us/): Не для RU региона, но внутри полезные скриншоты.
[Скачать иконку](https://developer.apple.com/support/downloads/Link-out-template.zip): Оригинальная иконка для кнопки на оплату на сайте.