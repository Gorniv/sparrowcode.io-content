Apple разрешила направлять пользователей из РФ на оплату на сайте прямо в приложении. Но чтобы вы могли это делать, сначала нужно подать заявку, получить разрешение и обновить приложения.

> Внутри одного региона вы не можете принимать внешние платежи и App Store. Нужно выбрать что-то одно.

Это пошаговая инструкция. Я расскажу с какими проблемаи столкнулись мы, это сэкономит вам время.

# Заявка

Заявка это что-то вроде анкеты, большинство полей заполянется автоматически. Подавать заявку [по этой ссылке](https://developer.apple.com/contact/request/storekit-external-entitlement-ru).

[xx2]

> Обязательно нужно принять соглашение о платных приложениях, иначе форма заявки не откроется.

Дальше в заявке введите название приложения (локализация не важна), Bundle ID и описание. Здесь мы написали что наши клиенты из РФ и хотим сделать нашим клиентам удобно.[xx3]

![Заполняете данные о приложении](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/request-app-info.jpg)

Следующий шаг — указать ваш эквайринг:

![Указываете ваш эквайринг](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/reqeust-payment-processing.jpg)

> Проверяйте чтобы эквайринг был не под санкциями. Нашу заявку отклонили, потому что мы указали ЮКассу.

Теперь указываете информация о веб-сайте, здесь нужно указать страницу оплаты (куда будете направлять пользователей) и страницу поддержки по вопросам платежей.

![Заполняете данные о приложении](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/request-website-info.jpg)

[xx5]

> URL в заявке должен совпадать с реальными ссылками. Эти URL вы будете добавлять в `Info.plist`.

Последний шаг — заполнить информацию о компании, заполянется руководителем:

[xx6]

# Проверка заявки

Нашу заявку отклоинили через 7 дней, потому что эквайринг ЮКасса пол санкциями. Мы сменили эквайринг на Райффайзен, заполнили новую заявку. Но не смогли ее отправить — наша старая заявка всё еще висела в статусе расмотрения.

Месяц мы связывались с Apple через eurodev@apple.com, и с трудом смогли анулировать первую заявку. Это была не наша вина, но мы потеряли месяц на этом.

Я отправил вторую заявку, и через 7 дней увидел в App Store Connect [xx7] что мне доступен `Additional Capabilities` для бандла приложения.

> Уведомлений на почту не получал, так что проверяйте Developer / Certifies,Identifiers & Profiles

Внутри `Additional Capabilities` выбираете `ExternalPurchaseLink` и применяете изменения. Теперь нужно интегрировать в приложение.  

# Настраиваем приложение

В списке Capability появится новое StoreKit External Purchase Link Entitlement (RU), добавляете к приложению:

![Добавляете Capability](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/capability.jpg)

В `Info.plist` добавляем словарь. В словаре указываем ссылку на оплату на сайте, для каждой страны своя ссылка:

```
<key></key>[xx8]
```

Сайт внешних покупок надо открывать не как ссылку, а вызывать `try await ExternalPurchaseLink.open()` из `StoreKit`. Пользователю покажут системный диклеймер, что “полномочия Apple всё”, и если что-то пойдёт не так, разбираться с разработчиком придётся самостоятельно.

[xx9]

# Проверка приложения

Обязательно в поле комментарий прикрепить видео, где видно процесс авторизации, окно со встроенными покупками и переход на сайт. Обязательно показать что URL совпадает с URL в заявке.

> В гайдах говорят про скриншот, но нас попросили именно видео.

Видео можно залить на хостинг, и в коментарий указать ссылку. Коментарий для ревьюера не пропадает между версиями, так что сделать это придется один раз.

Мы отправили билд на проверку, но получили реджект. Правила для UI обновили. Нельзя показывать тарифы, только кнопку на сайт для платежа. Символа иконки нет в SFSymbols, поэтому ниже в статье есть ссылка на картинку в векторе.

![Добавляете Capability](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/reject.jpg)

Мы обновили приложение и прошли в App Store:

[Rentel в App Store](https://apps.apple.com/app/id1632637156): Здесь описание приложения

На странице приложения в AppStore появилась вот такая метка. Мне бы больше понравился жёлтый восклицательный знак, но что поделать.

![Добавляете Capability](https://cdn.sparrowcode.io/tutorials/storekit-external-purchase-link-entitlement-ru/appstore-app-preview.jpg)

# Комиссия. Как платим

Каждый месяц мы отправляем отчеты по форме Apple о покупках. На основе отчетов в личном кабинете появляются счета за комиссию, 27%.

[xx10]

# Ссылки по теме

[Официальная Инструкция для RU](https://developer.apple.com/contact/request/storekit-external-entitlement-ru): Официальная инструкция и запрос StoreKit Entitlement. Ссылка открывается только с владельца аккаунта и регионом РФ. [xx1]
[Инструкиця для US](https://developer.apple.com/support/storekit-external-entitlement-us/): Не для RU региона, но внутри полезные скриншоты.
[Скачать иконку](https://developer.apple.com/support/downloads/Link-out-template.zip): Оригинальная иконка для кнопки на оплату на сайте.